<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ì–´ ë¬¸ì¥ í•™ìŠµ ì›¹ ì•±</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK ë¡œë“œ -->
    <script type="module">
        // Firebase SDK import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot,
            query
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyDei-FcTB97MjImOmQTLErKHpcjTi37bgI",
            authDomain: "flashcards-a103a.firebaseapp.com",
            projectId: "flashcards-a103a",
            storageBucket: "flashcards-a103a.firebasestorage.app",
            messagingSenderId: "450629867169",
            appId: "1:450629867169:web:181cc1e74d26daffdac2e0",
            measurementId: "G-07LGW9QKQF"
        };
        
        // Gemini API í‚¤ ì„¤ì •
        const GEMINI_API_KEY = "AIzaSyCBH6MrHK2JVTwAYE5jol32PRb_A8AG89I";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;

        const appId = 'default-app-id';

        // ì „ì—­ ë³€ìˆ˜
        let app, db, auth;
        let userId = null;
        let sentencesCollectionRef = null;
        let study_data = [];
        let mode = 'input';
        let current_question = null;
        let is_retry_mode = false;
        let selectedSentenceId = null;
        
        let reading_list = [];
        let current_read_index = 0;
        let is_playing = false;
        let reading_speed = 0.5;
        let readTimer = null;
        let countdownTimer = null;
        let countdown = 0;
        let autoNextTimer = null;

        // DOM ìš”ì†Œ ì°¸ì¡°
        let authFrame, mainFrame;
        let signupEmail, signupPassword, signupBtn;
        let loginEmail, loginPassword, loginBtn;
        let logoutBtn, userInfoSpan;
        let modeButtons, inputFrame, studyFrame, readingFrame;
        let inputEnglish, addSentenceBtn, fileInput, deleteBtn;
        let sentenceListBody;
        let studyStatsOverall, questionKorean, userAnswerEntry, resultFrame, resultLabel, correctAnswerLabel, userInputLabel, nextQuestionBtn, studyStats;
        let speedSelect, readingDisplay, countdownDisplay, readingProgress, playBtn, stopBtn;
        let messageModal, messageTitle, messageText, messageCloseBtn;
        let fileProgressModal, fileProgressText;

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            bindDOMElements();
            setupEventListeners();
            initFirebase();
        });

        function bindDOMElements() {
            // ì¸ì¦ ê´€ë ¨
            authFrame = document.getElementById('auth-frame');
            mainFrame = document.getElementById('main-frame');
            signupEmail = document.getElementById('signup-email');
            signupPassword = document.getElementById('signup-password');
            signupBtn = document.getElementById('signup-btn');
            loginEmail = document.getElementById('login-email');
            loginPassword = document.getElementById('login-password');
            loginBtn = document.getElementById('login-btn');
            logoutBtn = document.getElementById('logout-btn');
            userInfoSpan = document.getElementById('user-info');

            modeButtons = {
                input: document.getElementById('input-mode-btn'),
                study: document.getElementById('study-mode-btn'),
                reading: document.getElementById('reading-mode-btn'),
            };
            inputFrame = document.getElementById('input-frame');
            studyFrame = document.getElementById('study-frame');
            readingFrame = document.getElementById('reading-frame');

            // ì…ë ¥ ëª¨ë“œ
            inputEnglish = document.getElementById('input-english');
            addSentenceBtn = document.getElementById('add-sentence-btn');
            fileInput = document.getElementById('file-input');
            deleteBtn = document.getElementById('delete-btn');
            sentenceListBody = document.getElementById('sentence-list-body');

            // í•™ìŠµ ëª¨ë“œ
            studyStatsOverall = document.getElementById('study-stats-overall');
            questionKorean = document.getElementById('question-korean');
            userAnswerEntry = document.getElementById('user-answer-entry');
            resultFrame = document.getElementById('result-frame');
            resultLabel = document.getElementById('result-label');
            correctAnswerLabel = document.getElementById('correct-answer-label');
            userInputLabel = document.getElementById('user-input-label');
            nextQuestionBtn = document.getElementById('next-question-btn');
            studyStats = document.getElementById('study-stats');

            // ì½ê¸° ëª¨ë“œ
            speedSelect = document.getElementById('speed-select');
            readingDisplay = document.getElementById('reading-display');
            countdownDisplay = document.getElementById('countdown-display');
            readingProgress = document.getElementById('reading-progress');
            playBtn = document.getElementById('play-btn');
            stopBtn = document.getElementById('stop-btn');
            
            // ëª¨ë‹¬
            messageModal = document.getElementById('message-modal');
            messageTitle = document.getElementById('message-title');
            messageText = document.getElementById('message-text');
            messageCloseBtn = document.getElementById('message-close-btn');
            fileProgressModal = document.getElementById('file-progress-modal');
            fileProgressText = document.getElementById('file-progress-text');
        }

        function setupEventListeners() {
            // ì¸ì¦ ì´ë²¤íŠ¸
            signupBtn.addEventListener('click', handle_signup);
            loginBtn.addEventListener('click', handle_login);
            logoutBtn.addEventListener('click', handle_logout);

            // ëª¨ë“œ ì „í™˜ ë²„íŠ¼
            modeButtons.input.addEventListener('click', () => switch_mode('input'));
            modeButtons.study.addEventListener('click', start_study);
            modeButtons.reading.addEventListener('click', start_reading);

            // ì…ë ¥ ëª¨ë“œ
            addSentenceBtn.addEventListener('click', handle_add_sentence);
            inputEnglish.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handle_add_sentence();
            });
            fileInput.addEventListener('change', load_from_file);
            deleteBtn.addEventListener('click', delete_selected_sentence);

            // í•™ìŠµ ëª¨ë“œ
            userAnswerEntry.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') check_answer();
            });
            nextQuestionBtn.addEventListener('click', next_question);

            // ì½ê¸° ëª¨ë“œ
            speedSelect.addEventListener('change', update_reading_speed);
            playBtn.addEventListener('click', play_reading);
            stopBtn.addEventListener('click', stop_reading);
            
            // ëª¨ë‹¬ ë‹«ê¸°
            messageCloseBtn.addEventListener('click', () => messageModal.classList.add('hidden'));
        }

        function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userInfoSpan.textContent = user.email;
                        
                        sentencesCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'sentences');
                        
                        authFrame.classList.add('hidden');
                        mainFrame.classList.remove('hidden');
                        
                        loadData();
                        switch_mode('input');
                    } else {
                        userId = null;
                        study_data = [];
                        
                        authFrame.classList.remove('hidden');
                        mainFrame.classList.add('hidden');
                        
                        loginEmail.value = '';
                        loginPassword.value = '';
                        signupEmail.value = '';
                        signupPassword.value = '';
                    }
                });

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
                showMessage("ì¹˜ëª…ì  ì˜¤ë¥˜", "Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. " + error.message);
            }
        }

        async function handle_signup() {
            const email = signupEmail.value.trim();
            const password = signupPassword.value.trim();
            
            if (!email || !password) {
                showMessage("ê²½ê³ ", "ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            try {
                signupBtn.disabled = true;
                signupBtn.textContent = 'ê°€ì… ì¤‘...';
                
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage("ì„±ê³µ", "íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
                
                signupEmail.value = '';
                signupPassword.value = '';
            } catch (error) {
                let message = "íšŒì›ê°€ì… ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                if (error.code === 'auth/email-already-in-use') {
                    message = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
                } else if (error.code === 'auth/weak-password') {
                    message = "ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤. (ìµœì†Œ 6ì)";
                } else if (error.code === 'auth/invalid-email') {
                    message = "ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
                }
                showMessage("ì˜¤ë¥˜", message);
            } finally {
                signupBtn.disabled = false;
                signupBtn.textContent = 'íšŒì›ê°€ì…';
            }
        }

        async function handle_login() {
            const email = loginEmail.value.trim();
            const password = loginPassword.value.trim();
            
            if (!email || !password) {
                showMessage("ê²½ê³ ", "ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            try {
                loginBtn.disabled = true;
                loginBtn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
                
                await signInWithEmailAndPassword(auth, email, password);
                showMessage("ì„±ê³µ", "ë¡œê·¸ì¸ ë˜ì—ˆìŠµë‹ˆë‹¤!");
            } catch (error) {
                let message = "ë¡œê·¸ì¸ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                if (error.code === 'auth/user-not-found') {
                    message = "ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
                } else if (error.code === 'auth/wrong-password') {
                    message = "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.";
                } else if (error.code === 'auth/invalid-email') {
                    message = "ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
                }
                showMessage("ì˜¤ë¥˜", message);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'ë¡œê·¸ì¸';
            }
        }

        async function handle_logout() {
            try {
                await signOut(auth);
                showMessage("ë¡œê·¸ì•„ì›ƒ", "ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                stop_reading();
            } catch (error) {
                showMessage("ì˜¤ë¥˜", "ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: " + error.message);
            }
        }

        function loadData() {
            if (!sentencesCollectionRef) return;

            onSnapshot(query(sentencesCollectionRef), (snapshot) => {
                study_data = [];
                snapshot.forEach((doc) => {
                    study_data.push({ 
                        id: doc.id,
                        ...doc.data() 
                    });
                });
                
                if (mode === 'input') {
                    render_sentence_list();
                }
                updateOverallStats();

            }, (error) => {
                console.error("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                showMessage("ë°ì´í„° ì˜¤ë¥˜", "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. " + error.message);
            });
        }
        
        function updateOverallStats() {
            const total_study = study_data.reduce((sum, item) => sum + (item.studyCount || 0), 0);
            const total_correct = study_data.reduce((sum, item) => sum + (item.correctCount || 0), 0);
            const total_sentences = study_data.length;
            const ratio = total_study > 0 ? `${(total_correct / total_study * 100).toFixed(1)}%` : "N/A";
            
            if (studyStatsOverall) {
                studyStatsOverall.textContent = `ì´ ë¬¸ì¥ ìˆ˜: ${total_sentences} | ì „ì²´ í•™ìŠµ íšŸìˆ˜: ${total_study} | ì „ì²´ ì •ë‹µë¥ : ${ratio}`;
            }
        }

        async function getTranslation(englishText) {
            const payload = {
                contents: [{
                    parts: [{
                        text: `Translate the following English text to Korean. Provide only the Korean translation and nothing else:\n\n${englishText}`
                    }]
                }]
            };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0) {
                    return result.candidates[0].content.parts[0].text.trim();
                } else {
                    return '(ë²ˆì—­ ê²°ê³¼ ì—†ìŒ)';
                }
            } catch (error) {
                console.error("Gemini API ì˜¤ë¥˜:", error);
                return `(ë²ˆì—­ ì‹¤íŒ¨: ${error.message})`;
            }
        }

        async function handle_add_sentence() {
            const english = inputEnglish.value.trim();
            if (!english) {
                showMessage("ê²½ê³ ", "ì˜ì–´ ë¬¸ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            addSentenceBtn.disabled = true;
            addSentenceBtn.textContent = 'ë²ˆì—­ ì¤‘...';

            try {
                const korean = await getTranslation(english);
                
                const today = new Date().toISOString().split('T')[0];

                const new_entry = {
                    date: today,
                    english: english,
                    korean: korean,
                    studyCount: 0,
                    correctCount: 0,
                    lastStudyDate: null,
                    nextReviewDate: today
                };

                await addDoc(sentencesCollectionRef, new_entry);
                inputEnglish.value = '';

            } catch (error) {
                console.error("ë¬¸ì¥ ì¶”ê°€ ì‹¤íŒ¨:", error);
                showMessage("ì˜¤ë¥˜", "ë¬¸ì¥ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
            } finally {
                addSentenceBtn.disabled = false;
                addSentenceBtn.textContent = 'âœ“ ì…ë ¥ ë° ë²ˆì—­';
            }
        }

        function load_from_file() {
            const file = fileInput.files[0];
            if (!file) {
                showMessage("ê²½ê³ ", "íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const reader = new FileReader();
            reader.onload = async (event) => {
                const content = event.target.result;
                
                const sentences = content.split('.')
                    .map(s => s.trim())
                    .filter(s => s && s.length > 5);

                if (sentences.length === 0) {
                    showMessage("ê²½ê³ ", "ìœ íš¨í•œ ë¬¸ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                fileProgressModal.classList.remove('hidden');
                
                let added_count = 0;
                const total = sentences.length;

                for (let i = 0; i < total; i++) {
                    const sentence = sentences[i];
                    fileProgressText.textContent = `ì²˜ë¦¬ ì¤‘... ${i + 1} / ${total}`;

                    try {
                        const korean = await getTranslation(sentence);
                        const today = new Date().toISOString().split('T')[0];
                        
                        const new_entry = {
                            date: today,
                            english: sentence,
                            korean: korean,
                            studyCount: 0,
                            correctCount: 0,
                            lastStudyDate: null,
                            nextReviewDate: today
                        };
                        
                        await addDoc(sentencesCollectionRef, new_entry);
                        added_count++;

                        await new Promise(resolve => setTimeout(resolve, 200));

                    } catch (error) {
                        console.error(`íŒŒì¼ ë¬¸ì¥ ì²˜ë¦¬ ì˜¤ë¥˜: ${sentence}`, error);
                    }
                }
                
                fileProgressModal.classList.add('hidden');
                showMessage("ì™„ë£Œ", `${added_count}ê°œì˜ ë¬¸ì¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            };

            reader.onerror = () => {
                showMessage("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜", "íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            };
            
            reader.readAsText(file);
        }

        function render_sentence_list() {
            if (!sentenceListBody) return;
            
            sentenceListBody.innerHTML = '';
            selectedSentenceId = null;
            deleteBtn.disabled = true;

            // âœ… ìˆ˜ì •: Correctê°€ 0ì¸ ë¬¸ì¥ë§Œ í•„í„°ë§í•´ì„œ í‘œì‹œ
            const incorrect_data = study_data.filter(item => (item.correctCount || 0) === 0);                        
            // ID ì—­ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹  ì…ë ¥ì´ ìœ„ë¡œ)
            const sorted_data = [...incorrect_data].sort((a, b) => a.id < b.id ? 1 : -1);
            
            sorted_data.forEach(item => {
                const study_count = item.studyCount || 0;
                const correct_count = item.correctCount || 0;
                const ratio = study_count > 0 ? `${(correct_count / study_count * 100).toFixed(1)}%` : "N/A";
                const next_review = item.nextReviewDate || 'N/A';

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-100 cursor-pointer border-b border-gray-200';
                tr.dataset.id = item.id;
                
                tr.innerHTML = `
                    <td class="p-3">${item.english}</td>
                    <td class="p-3">${item.korean}</td>
                    <td class="p-3 text-center">${item.date}</td>
                    <td class="p-3 text-center">${study_count}</td>
                    <td class="p-3 text-center">${correct_count}</td>
                    <td class="p-3 text-center">${ratio}</td>
                    <td class="p-3 text-center">${next_review}</td>
                `;

                tr.addEventListener('click', () => {
                    Array.from(sentenceListBody.children).forEach(row => {
                        row.classList.remove('bg-blue-100', 'font-semibold');
                    });
                    tr.classList.add('bg-blue-100', 'font-semibold');
                    selectedSentenceId = item.id;
                    deleteBtn.disabled = false;
                });

                sentenceListBody.appendChild(tr);
            });
        }

        async function delete_selected_sentence() {
            if (!selectedSentenceId) {
                showMessage("ê²½ê³ ", "ì‚­ì œí•  ë¬¸ì¥ì„ ë¨¼ì € ëª©ë¡ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            if (!confirm("ì •ë§ë¡œ ì´ ë¬¸ì¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }

            try {
                await deleteDoc(doc(sentencesCollectionRef, selectedSentenceId));
                selectedSentenceId = null;
                deleteBtn.disabled = true;

            } catch (error) {
                console.error("ì‚­ì œ ì‹¤íŒ¨:", error);
                showMessage("ì˜¤ë¥˜", "ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
            }
        }

        function calculate_next_review_date(study_count, correct_rate) {
            const base_intervals = [1, 2, 4, 7, 15, 30, 60, 90];
            const interval_index = Math.min(study_count, base_intervals.length - 1);
            let base_interval = base_intervals[interval_index];
            
            let adjusted_interval;
            if (correct_rate >= 0.9) {
                adjusted_interval = base_interval * 1.5;
            } else if (correct_rate >= 0.7) {
                adjusted_interval = base_interval;
            } else if (correct_rate >= 0.5) {
                adjusted_interval = base_interval * 0.7;
            } else {
                adjusted_interval = Math.max(1, base_interval * 0.5);
            }
            
            const next_date = new Date();
            next_date.setDate(next_date.getDate() + Math.round(adjusted_interval));
            return next_date.toISOString().split('T')[0];
        }

        function get_priority(item) {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            const study_count = item.studyCount || 0;
            const correct_count = item.correctCount || 0;
            const next_review = item.nextReviewDate || todayStr;
            const last_study = item.lastStudyDate || '2000-01-01';

            const correct_rate = correct_count / Math.max(1, study_count);
            
            const nextReviewDate = new Date(next_review);
            const days_overdue = Math.max(0, (today.getTime() - nextReviewDate.getTime()) / (1000 * 60 * 60 * 24));

            return {
                p1: -days_overdue,
                p2: correct_rate,
                p3: study_count,
                p4: new Date(last_study).getTime()
            };
        }
        
        function get_prioritized_list() {
            if (study_data.length === 0) return [];

            return [...study_data].sort((a, b) => {
                const prioA = get_priority(a);
                const prioB = get_priority(b);

                if (prioA.p1 !== prioB.p1) return prioA.p1 - prioB.p1;
                if (prioA.p2 !== prioB.p2) return prioA.p2 - prioB.p2;
                if (prioA.p3 !== prioB.p3) return prioA.p3 - prioB.p3;
                return prioA.p4 - prioB.p4;
            });
        }

        function switch_mode(new_mode) {
            mode = new_mode;

            inputFrame.classList.add('hidden');
            studyFrame.classList.add('hidden');
            readingFrame.classList.add('hidden');
            
            Object.values(modeButtons).forEach(btn => btn.disabled = false);
            if (modeButtons[new_mode]) {
                modeButtons[new_mode].disabled = true;
            }

            stop_reading();

            if (new_mode === 'input') {
                inputFrame.classList.remove('hidden');
                render_sentence_list();
            } else if (new_mode === 'study') {
                studyFrame.classList.remove('hidden');
            } else if (new_mode === 'reading') {
                readingFrame.classList.remove('hidden');
            }
        }

        function start_study() {
            if (study_data.length === 0) {
                showMessage("ê²½ê³ ", "ì €ì¥ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤!");
                return;
            }

            switch_mode('study');
            is_retry_mode = false;

            const sorted_data = get_prioritized_list();
            
            const top_count = Math.max(3, Math.min(sorted_data.length, Math.ceil(sorted_data.length * 0.3)));
            const top_items = sorted_data.slice(0, top_count);
            
            current_question = top_items[Math.floor(Math.random() * top_items.length)];
            
            if (!current_question) {
                showMessage("ì˜¤ë¥˜", "í•™ìŠµí•  ë¬¸ì¥ì„ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                switch_mode('input');
                return;
            }

            //questionKorean.textContent = current_question.korean || '(ë²ˆì—­ ì—†ìŒ)';
            const firstWord = current_question.english.split(' ')[0]; // ì˜ì–´ ì²« ë‹¨ì–´ ì¶”ì¶œ
            questionKorean.innerHTML = `${current_question.korean || '(ë²ˆì—­ ì—†ìŒ)'}<br><span style="font-size: 14pt; color: #666; margin-top: 8px; display: block;">${firstWord} ... </span>`;
            
            userAnswerEntry.value = '';
            userAnswerEntry.disabled = false;
            userAnswerEntry.focus();

            resultFrame.classList.add('hidden');
            nextQuestionBtn.disabled = true;

            if (autoNextTimer) {
                clearTimeout(autoNextTimer);
                autoNextTimer = null;
            }

            const study_count = current_question.studyCount || 0;
            const correct_count = current_question.correctCount || 0;
            const next_review = current_question.nextReviewDate || 'N/A';
            studyStats.textContent = `í•™ìŠµ ${study_count}íšŒ | ì •ë‹µ ${correct_count}íšŒ | ë‹¤ìŒ ë³µìŠµ: ${next_review}`;
        }

        async function check_answer() {
            const user_answer = userAnswerEntry.value.trim();
            if (!user_answer) return;
            
            // íŠ¹ìˆ˜ë¬¸ì ì œê±° í•¨ìˆ˜
            const removeSpecialChars = (str) => str.replace(/[^a-zA-Z0-9\s]/g, '').trim();
            
            const userAnswerCleaned = removeSpecialChars(user_answer.toLowerCase());
            const correctAnswerCleaned = removeSpecialChars(current_question.english.toLowerCase());
            
            const is_correct_attempt = userAnswerCleaned === correctAnswerCleaned;

            if (is_retry_mode && !is_correct_attempt) {
                next_question();
                return;
            }
            
            resultFrame.classList.remove('hidden');
            
            let updatedData = {};
            
            if (is_correct_attempt) {
                resultLabel.textContent = "âœ… ì •ë‹µì…ë‹ˆë‹¤!";
                resultLabel.className = "text-3xl font-bold text-green-600";
                userInputLabel.textContent = "";
                correctAnswerLabel.textContent = `ì •ë‹µ: ${current_question.english}`;

                if (!is_retry_mode) {
                    const study_count = (current_question.studyCount || 0) + 1;
                    const correct_count = (current_question.correctCount || 0) + 1;
                    const correct_rate = correct_count / study_count;
                    
                    updatedData = {
                        studyCount: study_count,
                        correctCount: correct_count,
                        lastStudyDate: new Date().toISOString().split('T')[0],
                        nextReviewDate: calculate_next_review_date(study_count, correct_rate)
                    };
                }
                
                is_retry_mode = false;
                nextQuestionBtn.disabled = false;
                userAnswerEntry.disabled = true;
                
                autoNextTimer = setTimeout(next_question, 2000);

            } else {
                resultLabel.textContent = "âŒ í‹€ë ¸ìŠµë‹ˆë‹¤";
                resultLabel.className = "text-3xl font-bold text-red-600";
                userInputLabel.textContent = `ì…ë ¥: ${user_answer}`;
                correctAnswerLabel.textContent = `ì •ë‹µ: ${current_question.english}`;

                if (!is_retry_mode) {
                    const study_count = (current_question.studyCount || 0) + 1;
                    const correct_count = current_question.correctCount || 0;
                    const correct_rate = correct_count / study_count;

                    updatedData = {
                        studyCount: study_count,
                        lastStudyDate: new Date().toISOString().split('T')[0],
                        nextReviewDate: calculate_next_review_date(study_count, correct_rate)
                    };
                }
                
                is_retry_mode = true;
                nextQuestionBtn.disabled = false;
                userAnswerEntry.disabled = false;
                userAnswerEntry.focus();
            }

            if (Object.keys(updatedData).length > 0) {
                try {
                    await updateDoc(doc(sentencesCollectionRef, current_question.id), updatedData);
                    
                    const item = study_data.find(d => d.id === current_question.id);
                    if(item) {
                        Object.assign(item, updatedData);
                        studyStats.textContent = `í•™ìŠµ ${item.studyCount}íšŒ | ì •ë‹µ ${item.correctCount}íšŒ | ë‹¤ìŒ ë³µìŠµ: ${item.nextReviewDate}`;
                    }

                } catch (error) {
                    console.error("í•™ìŠµ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
                    showMessage("ì˜¤ë¥˜", "í•™ìŠµ ìƒíƒœ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            }
        }

        function next_question() {
            if (autoNextTimer) {
                clearTimeout(autoNextTimer);
                autoNextTimer = null;
            }
            userAnswerEntry.disabled = false;
            start_study();
        }

        function start_reading() {
            if (study_data.length === 0) {
                showMessage("ê²½ê³ ", "ì €ì¥ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤!");
                return;
            }
            
            switch_mode('reading');
            reading_list = get_prioritized_list();
            current_read_index = 0;
            is_playing = false;
            playBtn.disabled = false;
            stopBtn.disabled = true;
            readingDisplay.textContent = "";
            readingProgress.textContent = `ì´ ${reading_list.length}ê°œ ë¬¸ì¥ ì¤€ë¹„ ì™„ë£Œ (ë³µìŠµ ìš°ì„ ìˆœìœ„ ìˆœ)`;
        }
        
        function update_reading_speed() {
            const speed_map = {
                "ë¹ ë¥´ê²Œ": 0.3,
                "ì¤‘ê°„": 0.5,
                "ëŠë¦¬ê²Œ": 0.8
            };
            reading_speed = speed_map[speedSelect.value] || 0.5;
        }
        
        function calculate_display_time(sentence) {
            const word_count = sentence.split(' ').length;
            const display_time_sec = Math.max(2, Math.min(15, word_count * reading_speed));
            return Math.round(display_time_sec);
        }

        function play_reading() {
            if (reading_list.length === 0) return;
            is_playing = true;
            playBtn.disabled = true;
            stopBtn.disabled = false;
            show_next_sentence(current_read_index);
        }

        function stop_reading() {
            is_playing = false;
            playBtn.disabled = false;
            stopBtn.disabled = true;
            
            if (readTimer) {
                clearTimeout(readTimer);
                readTimer = null;
            }
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            countdownDisplay.textContent = "";
        }

        function show_next_sentence(index) {
            if (!is_playing) return;

            if (index >= reading_list.length) {
                stop_reading();
                readingDisplay.textContent = "âœ… í•™ìŠµ ì¢…ë£Œ!";
                return;
            }

            current_read_index = index;
            const current_sentence = reading_list[current_read_index].english;
            readingDisplay.textContent = current_sentence;
            readingProgress.textContent = `${current_read_index + 1} / ${reading_list.length}`;
            
            if (readTimer) clearTimeout(readTimer);
            if (countdownTimer) clearInterval(countdownTimer);

            countdown = calculate_display_time(current_sentence);
            countdownDisplay.textContent = countdown;
            
            countdownTimer = setInterval(() => {
                countdown--;
                if (countdown >= 0) {
                    countdownDisplay.textContent = countdown;
                } else {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                }
            }, 1000);

            readTimer = setTimeout(() => {
                show_next_sentence(index + 1);
            }, countdown * 1000);
        }

        function showMessage(title, message) {
            messageTitle.textContent = title;
            messageText.textContent = message;
            messageModal.classList.remove('hidden');
        }

    </script>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">

        <!-- ì¸ì¦ í™”ë©´ -->
        <div id="auth-frame" class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-20">
            <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-bold text-center text-blue-700 mb-6">ë¡œê·¸ì¸</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ì´ë©”ì¼:</label>
                        <input type="email" id="login-email" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500" placeholder="your@email.com">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ë¹„ë°€ë²ˆí˜¸:</label>
                        <input type="password" id="login-password" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500" placeholder="ë¹„ë°€ë²ˆí˜¸">
                    </div>
                    <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-300">
                        ë¡œê·¸ì¸
                    </button>
                </div>
            </div>

            <!-- íšŒì›ê°€ì… ì„¹ì…˜ -->
            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-bold text-center text-green-700 mb-6">íšŒì›ê°€ì…</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ì´ë©”ì¼:</label>
                        <input type="email" id="signup-email" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-green-500" placeholder="your@email.com">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">ë¹„ë°€ë²ˆí˜¸ (ìµœì†Œ 6ì):</label>
                        <input type="password" id="signup-password" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-green-500" placeholder="ë¹„ë°€ë²ˆí˜¸">
                    </div>
                    <button id="signup-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-300">
                        íšŒì›ê°€ì…
                    </button>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ í™”ë©´ -->
        <div class="text-gray-600 mt-2 text-right" style="font-size:10pt; font-style: italic;">Last update 2025.11.01 ver.05</div>
        <div id="main-frame" class="hidden">
            <!-- ìƒë‹¨: ì•± íƒ€ì´í‹€ ë° ë¡œê·¸ì•„ì›ƒ -->            
            <header class="bg-white shadow-md rounded-lg p-6 mb-6 flex justify-between items-center">                
                <div>
                    <h1 class="text-3xl font-bold text-blue-700">ì˜ì–´ ë¬¸ì¥ í•™ìŠµ ì›¹ ì•±</h1>
                    <p class="text-gray-600 font-semibold mt-2">Firestore & Gemini API</p>                    
                </div>
                <div class="text-right">                    
                    <p class="text-gray-700 font-semibold mb-2">ì‚¬ìš©ì: <span id="user-info" class="text-blue-600"></span></p>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </header>

            <!-- ëª¨ë“œ ì „í™˜ ë²„íŠ¼ -->
            <nav class="flex flex-wrap justify-center gap-4 mb-6">
                <button id="input-mode-btn" class="flex-1 min-w-[150px] bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 disabled:bg-gray-400">
                    ğŸ“ ë¬¸ì¥ ì…ë ¥ ë° ê´€ë¦¬
                </button>
                <button id="study-mode-btn" class="flex-1 min-w-[150px] bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 disabled:bg-gray-400">
                    ğŸ§  ë‹¤ì‹œ ê³µë¶€í•˜ê¸° (í•™ìŠµ)
                </button>
                <button id="reading-mode-btn" class="flex-1 min-w-[150px] bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 disabled:bg-gray-400">
                    ğŸ“– ê·¸ëƒ¥ ì½ê¸° (ë³µìŠµ)
                </button>
            </nav>

            <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
            <main>
                <!-- 1. ë¬¸ì¥ ì…ë ¥ ëª¨ë“œ -->
                <div id="input-frame" class="bg-white p-6 rounded-lg shadow-lg hidden">
                    <div class="bg-yellow-50 p-6 rounded-lg border-2 border-yellow-200 mb-6">
                        <label for="input-english" class="block text-lg font-semibold mb-2 text-gray-700">ì˜ì–´ ë¬¸ì¥ ë˜ëŠ” ë‹¨ì–´:</label>
                        <input type="text" id="input-english" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500 text-lg" placeholder="ì—¬ê¸°ì— ì˜ì–´ ë¬¸ì¥ ì…ë ¥ í›„ Enter...">
                        
                        <div class="flex flex-wrap gap-4 mt-4 justify-center">
                            <button id="add-sentence-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
                                âœ“ ì…ë ¥ ë° ë²ˆì—­
                            </button>
                            
                            <label for="file-input" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md cursor-pointer transition duration-300">
                                ğŸ“„ íŒŒì¼ë¡œ ì…ë ¥í•˜ê¸°
                            </label>
                            <input type="file" id="file-input" class="hidden" accept=".txt">
                            
                            <button id="delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 disabled:bg-gray-400" disabled>
                                ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ
                            </button>
                        </div>
                    </div>

                    <!-- ì €ì¥ëœ ë¬¸ì¥ ëª©ë¡ (Table) -->
                    <div class="mt-8">
                        <h3 class="text-2xl font-semibold mb-4 text-gray-800">ì €ì¥ëœ ë¬¸ì¥ ëª©ë¡</h3>
                        <!-- ëª¨ë°”ì¼ í™”ë©´ì—ì„œ ê°€ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • -->
                        <div class="shadow-md rounded-lg border border-gray-200">
                            <div class="overflow-y-auto h-80">
                                <table class="w-full min-w-[800px] bg-white">
                                    <thead class="bg-gray-200 sticky top-0">
                                        <tr>
                                            <th class="p-3 text-left font-semibold text-gray-700">English Sentence</th>
                                            <th class="p-3 text-left font-semibold text-gray-700">Korean Meaning</th>
                                            <th class="p-3 text-center font-semibold text-gray-700">Date</th>
                                            <th class="p-3 text-center font-semibold text-gray-700">Study</th>
                                            <th class="p-3 text-center font-semibold text-gray-700">Correct</th>
                                            <th class="p-3 text-center font-semibold text-gray-700">Ratio</th>
                                            <th class="p-3 text-center font-semibold text-gray-700">Next Review</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sentence-list-body">
                                        <tr>
                                            <td colspan="7" class="p-6 text-center text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. í•™ìŠµ ëª¨ë“œ -->
                <div id="study-frame" class="bg-green-50 p-6 md:p-10 rounded-lg shadow-lg text-center hidden">
                    <p id="study-stats-overall" class="text-md font-semibold text-green-800 mb-4"></p>
                    <h2 class="text-2xl font-bold text-green-900 mb-6">ë‹¤ìŒ ë¬¸ì¥ì„ ì˜ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”:</h2>

                    <div class="bg-white p-6 md:p-10 rounded-lg shadow-inner min-h-[150px] flex items-center justify-center">
                        <p id="question-korean" class="text-3xl font-bold text-gray-800"></p>
                    </div>

                    <input type="text" id="user-answer-entry" class="w-full max-w-2xl mx-auto p-4 mt-8 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-green-500 text-lg" placeholder="ì—¬ê¸°ì— ì˜ì–´ ë‹µì•ˆ ì…ë ¥ í›„ Enter...">

                    <div id="result-frame" class="bg-orange-50 p-6 rounded-lg shadow-inner mt-6 max-w-2xl mx-auto hidden">
                        <h3 id="result-label" class="text-3xl font-bold mb-4"></h3>
                        <p id="correct-answer-label" class="text-lg text-gray-700 mb-2"></p>
                        <p id="user-input-label" class="text-lg text-red-600"></p>
                        
                        <div class="mt-6">
                            <button id="next-question-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 disabled:bg-gray-400">
                                â¡ï¸ ë‹¤ìŒ í•™ìŠµ
                            </button>
                        </div>
                    </div>

                    <p id="study-stats" class="text-md text-gray-600 mt-6 font-semibold"></p>
                </div>

                <!-- 3. ì½ê¸° ëª¨ë“œ -->
                <div id="reading-frame" class="bg-blue-50 p-6 md:p-10 rounded-lg shadow-lg text-center hidden">
                    <h2 class="text-2xl font-bold text-blue-900 mb-6">ğŸ“– ê·¸ëƒ¥ ì½ê¸° (ë³µìŠµ ëª¨ë“œ)</h2>
                    
                    <div class="mb-6">
                        <label for="speed-select" class="text-lg font-semibold text-gray-700 mr-3">ì½ê¸° ì†ë„ ì„ íƒ:</label>
                        <select id="speed-select" class="p-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500">
                            <option value="ë¹ ë¥´ê²Œ">ë¹ ë¥´ê²Œ</option>
                            <option value="ì¤‘ê°„" selected>ì¤‘ê°„</option>
                            <option value="ëŠë¦¬ê²Œ">ëŠë¦¬ê²Œ</option>
                        </select>
                    </div>

                    <div class="bg-white p-10 rounded-lg shadow-inner min-h-[250px] flex items-center justify-center relative">
                        <p id="reading-display" class="text-4xl font-bold text-gray-800"></p>
                        <p id="countdown-display" class="absolute top-4 right-6 text-4xl font-bold text-orange-600"></p>
                    </div>

                    <p id="reading-progress" class="text-lg text-blue-800 mt-6 font-semibold"></p>
                    
                    <div class="flex justify-center gap-6 mt-6">
                        <button id="play-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300 text-2xl">
                            â–¶ Play
                        </button>
                        <button id="stop-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300 text-2xl disabled:bg-gray-400" disabled>
                            â¸ Stop
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ë©”ì‹œì§€ ëª¨ë‹¬ -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full">
            <div class="p-6 border-b border-gray-200">
                <h3 id="message-title" class="text-xl font-semibold text-gray-800"></h3>
            </div>
            <div class="p-6">
                <p id="message-text" class="text-gray-600"></p>
            </div>
            <div class="p-4 bg-gray-50 text-right rounded-b-lg">
                <button id="message-close-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg transition duration-300">
                    í™•ì¸
                </button>
            </div>
        </div>
    </div>
    
    <!-- íŒŒì¼ ì²˜ë¦¬ ì§„í–‰ ìƒí™© ëª¨ë‹¬ -->
    <div id="file-progress-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 text-center max-w-sm w-full">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">íŒŒì¼ ì²˜ë¦¬ ì¤‘</h3>
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
            <p id="file-progress-text" class="text-gray-700 text-lg"></p>
        </div>
    </div>

</body>
</html>
