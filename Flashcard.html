<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ì–´ ë¬¸ì¥ í•™ìŠµ ì›¹ ì•±</title>
    <!-- 1. Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Firebase SDK ë¡œë“œ -->
    <script type="module">
        // Firebase SDK import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken // signInWithCustomToken ì„í¬íŠ¸ ì¶”ê°€
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot,
            query
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // --- ì‚¬ìš©ì ì œê³µ ì„¤ì •ê°’ ---
        
        // 3. (ìš”ì²­) Firebase Config ì„¤ì •
        const userProvidedConfig = {
            apiKey: "AIzaSyDei-FcTB97MjImOmQTLErKHpcjTi37bgI",
            authDomain: "flashcards-a103a.firebaseapp.com",
            projectId: "flashcards-a103a",
            storageBucket: "flashcards-a103a.firebasestorage.app",
            messagingSenderId: "450629867169",
            appId: "1:450629867169:web:181cc1e74d26daffdac2e0",
            measurementId: "G-07LGW9QKQF"
        };
        
        // Canvas í™˜ê²½ ë³€ìˆ˜ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì‚¬ìš©ìê°€ ì œê³µí•œ ê°’ ì‚¬ìš©
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : userProvidedConfig;

        // 4. (ìš”ì²­) Gemini API í‚¤ ì„¤ì •
        const GEMINI_API_KEY = "AIzaSyCBH6MrHK2JVTwAYE5jol32PRb_A8AG89I";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;

        // Canvas App ID (Firestore ê²½ë¡œì— í•„ìˆ˜)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ---
        let app, db, auth;
        let userId = null;
        let sentencesCollectionRef = null;
        let study_data = []; // Firestore ë°ì´í„°ë¥¼ ë‹´ì„ ë¡œì»¬ ìºì‹œ
        let mode = 'input'; // 'input', 'study', 'reading'
        let current_question = null;
        let is_retry_mode = false;
        let selectedSentenceId = null; // Treeview(í…Œì´ë¸”)ì—ì„œ ì„ íƒëœ í•­ëª©ì˜ ID
        
        // ì½ê¸° ëª¨ë“œ ìƒíƒœ
        let reading_list = [];
        let current_read_index = 0;
        let is_playing = false;
        let reading_speed = 0.5; // ì¤‘ê°„ ì†ë„ (ë‹¨ì–´ë‹¹ 0.5ì´ˆ)
        let readTimer = null;
        let countdownTimer = null;
        let countdown = 0;

        // í•™ìŠµ ëª¨ë“œ ìƒíƒœ
        let autoNextTimer = null;

        // --- DOM ìš”ì†Œ ì°¸ì¡° ---
        let modeButtons, inputFrame, studyFrame, readingFrame;
        let inputEnglish, addSentenceBtn, fileInput, deleteBtn;
        let sentenceListBody;
        let studyStatsOverall, questionKorean, userAnswerEntry, resultFrame, resultLabel, correctAnswerLabel, userInputLabel, nextQuestionBtn, studyStats;
        let speedSelect, readingDisplay, countdownDisplay, readingProgress, playBtn, stopBtn;
        let messageModal, messageTitle, messageText, messageCloseBtn;
        let fileProgressModal, fileProgressText;

        // --- ì´ˆê¸°í™” ---
        document.addEventListener('DOMContentLoaded', () => {
            // DOM ìš”ì†Œ ë°”ì¸ë”©
            bindDOMElements();
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupEventListeners();
            // Firebase ì´ˆê¸°í™”
            initFirebase();
            // ì´ˆê¸° ëª¨ë“œ ì„¤ì •
            switch_mode('input');
        });

        function bindDOMElements() {
            modeButtons = {
                input: document.getElementById('input-mode-btn'),
                study: document.getElementById('study-mode-btn'),
                reading: document.getElementById('reading-mode-btn'),
            };
            inputFrame = document.getElementById('input-frame');
            studyFrame = document.getElementById('study-frame');
            readingFrame = document.getElementById('reading-frame');

            // ì…ë ¥ ëª¨ë“œ
            inputEnglish = document.getElementById('input-english');
            addSentenceBtn = document.getElementById('add-sentence-btn');
            fileInput = document.getElementById('file-input');
            deleteBtn = document.getElementById('delete-btn');
            sentenceListBody = document.getElementById('sentence-list-body');

            // í•™ìŠµ ëª¨ë“œ
            studyStatsOverall = document.getElementById('study-stats-overall');
            questionKorean = document.getElementById('question-korean');
            userAnswerEntry = document.getElementById('user-answer-entry');
            resultFrame = document.getElementById('result-frame');
            resultLabel = document.getElementById('result-label');
            correctAnswerLabel = document.getElementById('correct-answer-label');
            userInputLabel = document.getElementById('user-input-label');
            nextQuestionBtn = document.getElementById('next-question-btn');
            studyStats = document.getElementById('study-stats');

            // ì½ê¸° ëª¨ë“œ
            speedSelect = document.getElementById('speed-select');
            readingDisplay = document.getElementById('reading-display');
            countdownDisplay = document.getElementById('countdown-display');
            readingProgress = document.getElementById('reading-progress');
            playBtn = document.getElementById('play-btn');
            stopBtn = document.getElementById('stop-btn');
            
            // ëª¨ë‹¬
            messageModal = document.getElementById('message-modal');
            messageTitle = document.getElementById('message-title');
            messageText = document.getElementById('message-text');
            messageCloseBtn = document.getElementById('message-close-btn');
            fileProgressModal = document.getElementById('file-progress-modal');
            fileProgressText = document.getElementById('file-progress-text');
        }

        function setupEventListeners() {
            // ëª¨ë“œ ì „í™˜ ë²„íŠ¼
            modeButtons.input.addEventListener('click', () => switch_mode('input'));
            modeButtons.study.addEventListener('click', start_study);
            modeButtons.reading.addEventListener('click', start_reading);

            // ì…ë ¥ ëª¨ë“œ
            addSentenceBtn.addEventListener('click', handle_add_sentence);
            inputEnglish.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handle_add_sentence();
            });
            fileInput.addEventListener('change', load_from_file);
            deleteBtn.addEventListener('click', delete_selected_sentence);

            // í•™ìŠµ ëª¨ë“œ
            userAnswerEntry.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') check_answer();
            });
            nextQuestionBtn.addEventListener('click', next_question);

            // ì½ê¸° ëª¨ë“œ
            speedSelect.addEventListener('change', update_reading_speed);
            playBtn.addEventListener('click', play_reading);
            stopBtn.addEventListener('click', stop_reading);
            
            // ëª¨ë‹¬ ë‹«ê¸°
            messageCloseBtn.addEventListener('click', () => messageModal.classList.add('hidden'));
        }

        // --- Firebase ë° ë°ì´í„° ---

        function initFirebase() {
            try {
                // setLogLevel('debug'); // ë””ë²„ê·¸ ë¡œê·¸ í•„ìš”ì‹œ ì£¼ì„ í•´ì œ
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // console.log("ë¡œê·¸ì¸ ì„±ê³µ, userId:", userId);
                        
                        // (FIX): Canvas ë³´ì•ˆ ê·œì¹™ì— ë§ëŠ” Firestore ê²½ë¡œë¡œ ìˆ˜ì •
                        // old path: collection(db, 'users', userId, 'sentences');
                        sentencesCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'sentences');
                        
                        // ë°ì´í„° ì‹¤ì‹œê°„ ê°ì§€ ì‹œì‘
                        loadData();
                    } else {
                        userId = null;
                        study_data = [];
                        render_sentence_list();
                        console.log("ë¡œê·¸ì•„ì›ƒ ìƒíƒœ, ë¡œê·¸ì¸ ì‹œë„...");
                        // ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ ì‹œë„
                        signInUser();
                    }
                });

                // ë¡œê·¸ì¸ ë¡œì§ì„ ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
                async function signInUser() {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && typeof __firebase_config !== 'undefined') {
                            // Canvas í™˜ê²½: Custom Tokenìœ¼ë¡œ ë¡œê·¸ì¸
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            // ë¡œì»¬/ëŒ€ì²´ í™˜ê²½: ìµëª…ìœ¼ë¡œ ë¡œê·¸ì¸
                            // ì´ ê²½ìš° ì‚¬ìš©ìì˜ 'flashcards-a103a' í”„ë¡œì íŠ¸ì— 'ìµëª…' ê³µê¸‰ìê°€ í™œì„±í™”ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
                            await signInAnonymously(auth);
                        }
                        // ì„±ê³µí•˜ë©´ onAuthStateChangedê°€ ë‹¤ì‹œ í˜¸ì¶œë¨
                    } catch (error) {
                        console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                        let userMessage = "ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. " + error.message;
                        // ì‚¬ìš©ìê°€ ì œê³µí•œ configë¥¼ ì‚¬ìš© ì¤‘ì¼ ë•Œ ì´ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´, ëª…í™•í•œ ì•ˆë‚´ ì œê³µ
                        if (error.code === 'auth/configuration-not-found' && typeof __firebase_config === 'undefined') {
                            userMessage = "Firebase ì¸ì¦ ì˜¤ë¥˜: 'ìµëª…' ë¡œê·¸ì¸ ê³µê¸‰ìê°€ 'flashcards-a103a' í”„ë¡œì íŠ¸ì˜ Firebase ì½˜ì†”ì—ì„œ í™œì„±í™”ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. (auth/configuration-not-found)";
                        } else if (error.code === 'auth/configuration-not-found') {
                             userMessage = "Firebase ì¸ì¦ ì˜¤ë¥˜: Canvas í”„ë¡œì íŠ¸ ì„¤ì •ì— 'ìµëª…' ë¡œê·¸ì¸ì´ í™œì„±í™”ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. (auth/configuration-not-found)";
                        }
                        showMessage("Firebase ì˜¤ë¥˜", userMessage);
                    }
                }

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
                showMessage("ì¹˜ëª…ì  ì˜¤ë¥˜", "Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. " + error.message);
            }
        }

        /**
         * Firestoreì—ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ê³  ì‹¤ì‹œê°„ ë³€ê²½ ì‚¬í•­ì„ ê°ì§€í•©ë‹ˆë‹¤.
         * (Pythonì˜ load_data() ëŒ€ì²´)
         */
        function loadData() {
            if (!sentencesCollectionRef) return;

            // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            onSnapshot(query(sentencesCollectionRef), (snapshot) => {
                study_data = []; // ë¡œì»¬ ìºì‹œ ì´ˆê¸°í™”
                snapshot.forEach((doc) => {
                    study_data.push({ 
                        id: doc.id, // Firestore ë¬¸ì„œ ID í¬í•¨
                        ...doc.data() 
                    });
                });
                
                // console.log("ë°ì´í„° ë¡œë“œë¨:", study_data.length, "ê°œ");
                
                // ë°ì´í„°ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ UI ê°±ì‹ 
                if (mode === 'input') {
                    render_sentence_list();
                }
                updateOverallStats();

            }, (error) => {
                console.error("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                showMessage("ë°ì´í„° ì˜¤ë¥˜", "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. " + error.message);
            });
        }
        
        /**
         * ì „ì²´ í•™ìŠµ í†µê³„ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateOverallStats() {
            const total_study = study_data.reduce((sum, item) => sum + (item.studyCount || 0), 0);
            const total_correct = study_data.reduce((sum, item) => sum + (item.correctCount || 0), 0);
            const total_sentences = study_data.length;
            const ratio = total_study > 0 ? `${(total_correct / total_study * 100).toFixed(1)}%` : "N/A";
            
            if (studyStatsOverall) {
                studyStatsOverall.textContent = `ì´ ë¬¸ì¥ ìˆ˜: ${total_sentences} | ì „ì²´ í•™ìŠµ íšŸìˆ˜: ${total_study} | ì „ì²´ ì •ë‹µë¥ : ${ratio}`;
            }
        }

        // --- í•µì‹¬ ë¡œì§ (Python í¬íŒ…) ---

        /**
         * ëª¨ë“œë¥¼ ì „í™˜í•©ë‹ˆë‹¤.
         * (Pythonì˜ switch_mode)
         */
        function switch_mode(new_mode) {
            mode = new_mode;

            // ëª¨ë“  í”„ë ˆì„ ìˆ¨ê¸°ê¸°
            inputFrame.classList.add('hidden');
            studyFrame.classList.add('hidden');
            readingFrame.classList.add('hidden');
            
            // ëª¨ë“œ ë²„íŠ¼ í™œì„±/ë¹„í™œì„±
            Object.values(modeButtons).forEach(btn => btn.disabled = false);
            if (modeButtons[new_mode]) {
                modeButtons[new_mode].disabled = true;
            }

            // ì½ê¸° ëª¨ë“œ ì¤‘ì§€ (íƒ€ì´ë¨¸ ì •ë¦¬)
            stop_reading();

            // ìƒˆ ëª¨ë“œ í”„ë ˆì„ í‘œì‹œ
            if (new_mode === 'input') {
                inputFrame.classList.remove('hidden');
                render_sentence_list(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } else if (new_mode === 'study') {
                studyFrame.classList.remove('hidden');
            } else if (new_mode === 'reading') {
                readingFrame.classList.remove('hidden');
            }
        }

        /**
         * (ìš”ì²­) Gemini APIë¥¼ í˜¸ì¶œí•˜ì—¬ ë²ˆì—­í•©ë‹ˆë‹¤.
         * (Pythonì˜ translator.translate ëŒ€ì²´)
         */
        async function getTranslation(englishText) {
            const payload = {
                contents: [{
                    parts: [{
                        // Geminiì—ê²Œ ëª…í™•í•œ ì—­í•  ë¶€ì—¬
                        text: `Translate the following English text to Korean. Provide only the Korean translation and nothing else:\n\n${englishText}`
                    }]
                }]
            };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0) {
                    return result.candidates[0].content.parts[0].text.trim();
                } else {
                    return '(ë²ˆì—­ ê²°ê³¼ ì—†ìŒ)';
                }
            } catch (error) {
                console.error("Gemini API ì˜¤ë¥˜:", error);
                return `(ë²ˆì—­ ì‹¤íŒ¨: ${error.message})`;
            }
        }

        /**
         * ìƒˆ ë¬¸ì¥ì„ ì…ë ¥í•˜ê³  ë²ˆì—­í•˜ì—¬ Firestoreì— ì¶”ê°€í•©ë‹ˆë‹¤.
         * (Pythonì˜ handle_add_sentence + save_data ì¼ë¶€)
         */
        async function handle_add_sentence() {
            const english = inputEnglish.value.trim();
            if (!english) {
                showMessage("ê²½ê³ ", "ì˜ì–´ ë¬¸ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            addSentenceBtn.disabled = true;
            addSentenceBtn.textContent = 'ë²ˆì—­ ì¤‘...';

            try {
                const korean = await getTranslation(english);
                
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

                const new_entry = {
                    // 'id'ëŠ” Firestoreì—ì„œ ìë™ ìƒì„±ë©ë‹ˆë‹¤.
                    date: today,
                    english: english,
                    korean: korean,
                    studyCount: 0,
                    correctCount: 0,
                    lastStudyDate: null,
                    nextReviewDate: today // ë‹¤ìŒ ë³µìŠµ ë‚ ì§œ (ì²˜ìŒì—” ì˜¤ëŠ˜)
                };

                // Firestoreì— ë¬¸ì„œ ì¶”ê°€
                await addDoc(sentencesCollectionRef, new_entry);
                
                // onSnapshotì´ UIë¥¼ ìë™ ê°±ì‹ í•©ë‹ˆë‹¤.
                inputEnglish.value = '';

            } catch (error) {
                console.error("ë¬¸ì¥ ì¶”ê°€ ì‹¤íŒ¨:", error);
                showMessage("ì˜¤ë¥˜", "ë¬¸ì¥ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
            } finally {
                addSentenceBtn.disabled = false;
                addSentenceBtn.textContent = 'âœ“ ì…ë ¥ ë° ë²ˆì—­';
            }
        }

        /**
         * í…ìŠ¤íŠ¸ íŒŒì¼ì—ì„œ ë¬¸ì¥ì„ ì½ì–´ì™€ Firestoreì— ì¶”ê°€í•©ë‹ˆë‹¤.
         * (Pythonì˜ load_from_file)
         */
        function load_from_file() {
            const file = fileInput.files[0];
            if (!file) {
                showMessage("ê²½ê³ ", "íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const reader = new FileReader();
            reader.onload = async (event) => {
                const content = event.target.result;
                
                // ë§ˆì¹¨í‘œ ë‹¨ìœ„ë¡œ ë¬¸ì¥ ë¶„ë¦¬ (Python ë¡œì§ê³¼ ë™ì¼)
                const sentences = content.split('.')
                    .map(s => s.trim())
                    .filter(s => s && s.length > 5); // ë„ˆë¬´ ì§§ì€ ë¬¸ì¥ ì œì™¸

                if (sentences.length === 0) {
                    showMessage("ê²½ê³ ", "ìœ íš¨í•œ ë¬¸ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                // ì§„í–‰ ìƒí™© ëª¨ë‹¬ í‘œì‹œ
                fileProgressModal.classList.remove('hidden');
                
                let added_count = 0;
                const total = sentences.length;

                for (let i = 0; i < total; i++) {
                    const sentence = sentences[i];
                    fileProgressText.textContent = `ì²˜ë¦¬ ì¤‘... ${i + 1} / ${total}`;

                    try {
                        const korean = await getTranslation(sentence);
                        const today = new Date().toISOString().split('T')[0];
                        
                        const new_entry = {
                            date: today,
                            english: sentence,
                            korean: korean,
                            studyCount: 0,
                            correctCount: 0,
                            lastStudyDate: null,
                            nextReviewDate: today
                        };
                        
                        await addDoc(sentencesCollectionRef, new_entry);
                        added_count++;

                        // API ì œí•œ ë°©ì§€ë¥¼ ìœ„í•œ ì§§ì€ ëŒ€ê¸° (Pythonì˜ time.sleep)
                        await new Promise(resolve => setTimeout(resolve, 200)); // 200ms

                    } catch (error) {
                        console.error(`íŒŒì¼ ë¬¸ì¥ ì²˜ë¦¬ ì˜¤ë¥˜: ${sentence}`, error);
                        // ì˜¤ë¥˜ê°€ ë‚˜ë„ ê³„ì† ì§„í–‰
                    }
                }
                
                fileProgressModal.classList.add('hidden');
                showMessage("ì™„ë£Œ", `${added_count}ê°œì˜ ë¬¸ì¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                // onSnapshotì´ ëª©ë¡ì„ ìë™ ê°±ì‹ í•©ë‹ˆë‹¤.
            };

            reader.onerror = () => {
                showMessage("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜", "íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            };
            
            reader.readAsText(file);
        }

        /**
         * ì…ë ¥ ëª¨ë“œì˜ ëª©ë¡(í…Œì´ë¸”)ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
         * (Pythonì˜ render_sentence_list)
         */
        function render_sentence_list() {
            if (!sentenceListBody) return;
            
            sentenceListBody.innerHTML = ''; // ëª©ë¡ ë¹„ìš°ê¸°
            selectedSentenceId = null; // ì„ íƒ í•´ì œ
            deleteBtn.disabled = true;

            const sorted_data = [...study_data].sort((a, b) => new Date(b.date) - new Date(a.date)); // ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ

            sorted_data.forEach(item => {
                const study_count = item.studyCount || 0;
                const correct_count = item.correctCount || 0;
                const ratio = study_count > 0 ? `${(correct_count / study_count * 100).toFixed(1)}%` : "N/A";
                const next_review = item.nextReviewDate || 'N/A';

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-100 cursor-pointer border-b border-gray-200';
                tr.dataset.id = item.id; // Firestore ID ì €ì¥
                
                tr.innerHTML = `
                    <td class="p-3">${item.english}</td>
                    <td class="p-3">${item.korean}</td>
                    <td class="p-3 text-center">${item.date}</td>
                    <td class="p-3 text-center">${study_count}</td>
                    <td class="p-3 text-center">${correct_count}</td>
                    <td class="p-3 text-center">${ratio}</td>
                    <td class="p-3 text-center">${next_review}</td>
                `;

                // ì„ íƒ ì´ë²¤íŠ¸
                tr.addEventListener('click', () => {
                    // ê¸°ì¡´ ì„ íƒ í•´ì œ
                    Array.from(sentenceListBody.children).forEach(row => {
                        row.classList.remove('bg-blue-100', 'font-semibold');
                    });
                    // ìƒˆ í•­ëª© ì„ íƒ
                    tr.classList.add('bg-blue-100', 'font-semibold');
                    selectedSentenceId = item.id;
                    deleteBtn.disabled = false;
                });

                sentenceListBody.appendChild(tr);
            });
        }

        /**
         * ì„ íƒëœ ë¬¸ì¥ì„ ì‚­ì œí•©ë‹ˆë‹¤.
         * (Pythonì˜ delete_selected_sentence)
         */
        async function delete_selected_sentence() {
            if (!selectedSentenceId) {
                showMessage("ê²½ê³ ", "ì‚­ì œí•  ë¬¸ì¥ì„ ë¨¼ì € ëª©ë¡ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            if (!confirm("ì •ë§ë¡œ ì´ ë¬¸ì¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }

            try {
                // Firestoreì—ì„œ ë¬¸ì„œ ì‚­ì œ
                await deleteDoc(doc(sentencesCollectionRef, selectedSentenceId));
                
                // onSnapshotì´ UIë¥¼ ìë™ ê°±ì‹ í•©ë‹ˆë‹¤.
                selectedSentenceId = null;
                deleteBtn.disabled = true;
                // showMessage("ì‚­ì œ ì™„ë£Œ", "ì„ íƒí•œ ë¬¸ì¥ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); // onSnapshotì´ ê°±ì‹ í•˜ë¯€ë¡œ ë¶ˆí•„ìš”

            } catch (error) {
                console.error("ì‚­ì œ ì‹¤íŒ¨:", error);
                showMessage("ì˜¤ë¥˜", "ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
            }
        }

        /**
         * ì—ë¹™í•˜ìš°ìŠ¤ ë§ê° ê³¡ì„  ê¸°ë°˜ ë‹¤ìŒ ë³µìŠµ ë‚ ì§œ ê³„ì‚°
         * (Pythonì˜ calculate_next_review_date í¬íŒ…)
         */
        function calculate_next_review_date(study_count, correct_rate) {
            const base_intervals = [1, 2, 4, 7, 15, 30, 60, 90];
            const interval_index = Math.min(study_count, base_intervals.length - 1);
            let base_interval = base_intervals[interval_index];
            
            let adjusted_interval;
            if (correct_rate >= 0.9) {
                adjusted_interval = base_interval * 1.5;
            } else if (correct_rate >= 0.7) {
                adjusted_interval = base_interval;
            } else if (correct_rate >= 0.5) {
                adjusted_interval = base_interval * 0.7;
            } else {
                adjusted_interval = Math.max(1, base_interval * 0.5);
            }
            
            const next_date = new Date();
            next_date.setDate(next_date.getDate() + Math.round(adjusted_interval));
            return next_date.toISOString().split('T')[0]; // YYYY-MM-DD
        }

        /**
         * ë§ê° ê³¡ì„  ê¸°ë°˜ ìš°ì„ ìˆœìœ„ ê³„ì‚° (Helper)
         * (Pythonì˜ start_study/get_priority í¬íŒ…)
         */
        function get_priority(item) {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            const study_count = item.studyCount || 0;
            const correct_count = item.correctCount || 0;
            const next_review = item.nextReviewDate || todayStr;
            const last_study = item.lastStudyDate || '2000-01-01';

            const correct_rate = correct_count / Math.max(1, study_count);
            
            // ë³µìŠµ ì˜ˆì •ì¼ì´ ì§€ë‚¬ëŠ”ì§€ í™•ì¸
            const nextReviewDate = new Date(next_review);
            const days_overdue = Math.max(0, (today.getTime() - nextReviewDate.getTime()) / (1000 * 60 * 60 * 24));

            // ìš°ì„ ìˆœìœ„ (ë‚®ì„ìˆ˜ë¡ ë¨¼ì € í•™ìŠµ)
            // 1. ë³µìŠµ ì˜ˆì •ì¼ì´ ì§€ë‚œ í•­ëª© ìš°ì„ 
            // 2. ì •ë‹µë¥ ì´ ë‚®ì€ í•­ëª© ìš°ì„ 
            // 3. í•™ìŠµ íšŸìˆ˜ê°€ ì ì€ í•­ëª© ìš°ì„ 
            // 4. ì˜¤ë˜ëœ í•­ëª© ìš°ì„ 
            
            // JavaScriptì˜ sort()ë¥¼ ìœ„í•´ ë¹„êµ ê°€ëŠ¥í•œ ê°’ ë°˜í™˜
            // Pythonì˜ íŠœí”Œ ì •ë ¬ì„ ë°°ì—´/ê°ì²´ë¡œ í‰ë‚´
            return {
                p1: -days_overdue, // (ìŒìˆ˜ë¡œ ë§Œë“¤ì–´ ê°’ì´ ì‘ì„ìˆ˜ë¡ ìš°ì„ )
                p2: correct_rate,  // (ì •ë‹µë¥  ë‚®ì„ìˆ˜ë¡ ìš°ì„ )
                p3: study_count,   // (í•™ìŠµ íšŸìˆ˜ ì ì„ìˆ˜ë¡ ìš°ì„ )
                p4: new Date(last_study).getTime() // (ì˜¤ë˜ëœ ë‚ ì§œì¼ìˆ˜ë¡ ìš°ì„ )
            };
        }
        
        /**
         * ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ì •ë ¬ëœ í•™ìŠµ ëª©ë¡ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
         */
        function get_prioritized_list() {
            if (study_data.length === 0) return [];

            return [...study_data].sort((a, b) => {
                const prioA = get_priority(a);
                const prioB = get_priority(b);

                if (prioA.p1 !== prioB.p1) return prioA.p1 - prioB.p1;
                if (prioA.p2 !== prioB.p2) return prioA.p2 - prioB.p2;
                if (prioA.p3 !== prioB.p3) return prioA.p3 - prioB.p3;
                return prioA.p4 - prioB.p4;
            });
        }

        /**
         * 'ë‹¤ì‹œ ê³µë¶€í•˜ê¸°' ëª¨ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
         * (Pythonì˜ start_study í¬íŒ…)
         */
        function start_study() {
            if (study_data.length === 0) {
                showMessage("ê²½ê³ ", "ì €ì¥ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤!");
                return;
            }

            switch_mode('study');
            is_retry_mode = false;

            // ìš°ì„ ìˆœìœ„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const sorted_data = get_prioritized_list();
            
            // ìƒìœ„ 30%ì—ì„œ ë¬´ì‘ìœ„ ì„ íƒ (ìµœì†Œ 3ê°œ, ìµœëŒ€ ì „ì²´)
            const top_count = Math.max(3, Math.min(sorted_data.length, Math.ceil(sorted_data.length * 0.3)));
            const top_items = sorted_data.slice(0, top_count);
            
            current_question = top_items[Math.floor(Math.random() * top_items.length)];
            
            if (!current_question) {
                showMessage("ì˜¤ë¥˜", "í•™ìŠµí•  ë¬¸ì¥ì„ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                switch_mode('input');
                return;
            }

            questionKorean.textContent = current_question.korean || '(ë²ˆì—­ ì—†ìŒ)';
            userAnswerEntry.value = '';
            userAnswerEntry.disabled = false;
            userAnswerEntry.focus();

            // ê²°ê³¼ í”„ë ˆì„ ì´ˆê¸°í™”
            resultFrame.classList.add('hidden');
            nextQuestionBtn.disabled = true;

            // ìë™ ì´ë™ íƒ€ì´ë¨¸ ì·¨ì†Œ
            if (autoNextTimer) {
                clearTimeout(autoNextTimer);
                autoNextTimer = null;
            }

            // í˜„ì¬ ë¬¸ì¥ í†µê³„
            const study_count = current_question.studyCount || 0;
            const correct_count = current_question.correctCount || 0;
            const next_review = current_question.nextReviewDate || 'N/A';
            studyStats.textContent = `**í˜„ì¬ ë¬¸ì¥ í†µê³„:** í•™ìŠµ ${study_count}íšŒ | ì •ë‹µ ${correct_count}íšŒ | ë‹¤ìŒ ë³µìŠµ: ${next_review}`;
        }

        /**
         * ë‹µì•ˆì„ í™•ì¸í•©ë‹ˆë‹¤.
         * (Pythonì˜ check_answer í¬íŒ…)
         */
        async function check_answer() {
            const user_answer = userAnswerEntry.value.trim();
            if (!user_answer) return;
            
            const is_correct_attempt = user_answer.toLowerCase() === current_question.english.toLowerCase();

            // ì¬ì‹œë„ ëª¨ë“œì—ì„œ ì˜¤ë‹µ -> 'ë‹¤ìŒ í•™ìŠµ'
            if (is_retry_mode && !is_correct_attempt) {
                next_question();
                return;
            }
            
            resultFrame.classList.remove('hidden');
            
            // Firestore ì—…ë°ì´íŠ¸ìš© ê°ì²´
            let updatedData = {};
            
            if (is_correct_attempt) {
                resultLabel.textContent = "âœ… ì •ë‹µì…ë‹ˆë‹¤!";
                resultLabel.className = "text-3xl font-bold text-green-600";
                userInputLabel.textContent = "";
                correctAnswerLabel.textContent = `ì •ë‹µ: ${current_question.english}`;

                // ì²« ì‹œë„ì—ë§Œ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                if (!is_retry_mode) {
                    const study_count = (current_question.studyCount || 0) + 1;
                    const correct_count = (current_question.correctCount || 0) + 1;
                    const correct_rate = correct_count / study_count;
                    
                    updatedData = {
                        studyCount: study_count,
                        correctCount: correct_count,
                        lastStudyDate: new Date().toISOString().split('T')[0],
                        nextReviewDate: calculate_next_review_date(study_count, correct_rate)
                    };
                }
                
                is_retry_mode = false;
                nextQuestionBtn.disabled = false;
                userAnswerEntry.disabled = true; // ì •ë‹µ ì‹œ ì…ë ¥ ë¹„í™œì„±í™”
                
                // 2ì´ˆ í›„ ìë™ ì´ë™
                autoNextTimer = setTimeout(next_question, 2000);

            } else { // ì˜¤ë‹µ
                resultLabel.textContent = "âŒ í‹€ë ¸ìŠµë‹ˆë‹¤";
                resultLabel.className = "text-3xl font-bold text-red-600";
                userInputLabel.textContent = `ì…ë ¥: ${user_answer}`;
                correctAnswerLabel.textContent = `ì •ë‹µ: ${current_question.english}`;

                // ì²« ì‹œë„ì—ë§Œ ì˜¤ë‹µìœ¼ë¡œ ì¹´ìš´íŠ¸ ì¦ê°€
                if (!is_retry_mode) {
                    const study_count = (current_question.studyCount || 0) + 1;
                    const correct_count = current_question.correctCount || 0; // ì •ë‹µ ìˆ˜ëŠ” ê·¸ëŒ€ë¡œ
                    const correct_rate = correct_count / study_count;

                    updatedData = {
                        studyCount: study_count,
                        lastStudyDate: new Date().toISOString().split('T')[0],
                        nextReviewDate: calculate_next_review_date(study_count, correct_rate)
                    };
                }
                
                is_retry_mode = true;
                nextQuestionBtn.disabled = false;
                userAnswerEntry.disabled = false;
                userAnswerEntry.focus();
            }

            // Firestore ì—…ë°ì´íŠ¸ (ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ)
            if (Object.keys(updatedData).length > 0) {
                try {
                    await updateDoc(doc(sentencesCollectionRef, current_question.id), updatedData);
                    
                    // onSnapshotì´ í†µê³„ë¥¼ ê°±ì‹ í•˜ì§€ë§Œ, ì¦‰ê°ì ì¸ í”¼ë“œë°±ì„ ìœ„í•´ ìˆ˜ë™ ê°±ì‹ 
                    const item = study_data.find(d => d.id === current_question.id);
                    if(item) {
                        Object.assign(item, updatedData); // ë¡œì»¬ ìºì‹œë„ ê°±ì‹ 
                        studyStats.textContent = `**í˜„ì¬ ë¬¸ì¥ í†µê³„:** í•™ìŠµ ${item.studyCount}íšŒ | ì •ë‹µ ${item.correctCount}íšŒ | ë‹¤ìŒ ë³µìŠµ: ${item.nextReviewDate}`;
                    }

                } catch (error) {
                    console.error("í•™ìŠµ ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
                    showMessage("ì˜¤ë¥˜", "í•™ìŠµ ìƒíƒœ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            }
        }

        /**
         * ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.
         * (Pythonì˜ next_question)
         */
        function next_question() {
            if (autoNextTimer) {
                clearTimeout(autoNextTimer);
                autoNextTimer = null;
            }
            userAnswerEntry.disabled = false;
            start_study(); // ìƒˆ í•™ìŠµ ì‹œì‘
        }

        // --- ì½ê¸° ëª¨ë“œ ë¡œì§ (Python í¬íŒ…) ---

        /**
         * 'ê·¸ëƒ¥ ì½ê¸°' ëª¨ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
         * (Pythonì˜ start_reading)
         */
        function start_reading() {
            if (study_data.length === 0) {
                showMessage("ê²½ê³ ", "ì €ì¥ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤!");
                return;
            }
            
            switch_mode('reading');

            // ìš°ì„ ìˆœìœ„ ìˆœìœ¼ë¡œ ì •ë ¬ (í•™ìŠµ ëª¨ë“œì™€ ë™ì¼)
            reading_list = get_prioritized_list();
            
            current_read_index = 0;
            is_playing = false;
            playBtn.disabled = false;
            stopBtn.disabled = true;
            readingDisplay.textContent = "";
            readingProgress.textContent = `ì´ ${reading_list.length}ê°œ ë¬¸ì¥ ì¤€ë¹„ ì™„ë£Œ (ë³µìŠµ ìš°ì„ ìˆœìœ„ ìˆœ)`;
        }
        
        /**
         * ì½ê¸° ì†ë„ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         * (Pythonì˜ update_reading_speed)
         */
        function update_reading_speed() {
            const speed_map = {
                "ë¹ ë¥´ê²Œ": 0.3,
                "ì¤‘ê°„": 0.5,
                "ëŠë¦¬ê²Œ": 0.8
            };
            reading_speed = speed_map[speedSelect.value] || 0.5;
        }
        
        /**
         * ë¬¸ì¥ í‘œì‹œ ì‹œê°„ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
         * (Pythonì˜ calculate_display_time)
         */
        function calculate_display_time(sentence) {
            const word_count = sentence.split(' ').length;
            const display_time_sec = Math.max(2, Math.min(15, word_count * reading_speed));
            return Math.round(display_time_sec); // ì´ˆ ë‹¨ìœ„ ì •ìˆ˜
        }

        function play_reading() {
            if (reading_list.length === 0) return;
            is_playing = true;
            playBtn.disabled = true;
            stopBtn.disabled = false;
            show_next_sentence(current_read_index);
        }

        function stop_reading() {
            is_playing = false;
            playBtn.disabled = false;
            stopBtn.disabled = true;
            
            if (readTimer) {
                clearTimeout(readTimer);
                readTimer = null;
            }
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            countdownDisplay.textContent = "";
        }

        function show_next_sentence(index) {
            if (!is_playing) return;

            if (index >= reading_list.length) {
                stop_reading();
                readingDisplay.textContent = "âœ… í•™ìŠµ ì¢…ë£Œ!";
                return;
            }

            current_read_index = index;
            const current_sentence = reading_list[current_read_index].english;
            readingDisplay.textContent = current_sentence;
            readingProgress.textContent = `${current_read_index + 1} / ${reading_list.length}`;
            
            // íƒ€ì´ë¨¸ ì¤‘ì§€
            if (readTimer) clearTimeout(readTimer);
            if (countdownTimer) clearInterval(countdownTimer);

            // í‘œì‹œ ì‹œê°„ ê³„ì‚°
            countdown = calculate_display_time(current_sentence);
            countdownDisplay.textContent = countdown;
            
            // ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸ ì‹œì‘ (1ì´ˆë§ˆë‹¤)
            countdownTimer = setInterval(() => {
                countdown--;
                if (countdown >= 0) {
                    countdownDisplay.textContent = countdown;
                } else {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                }
            }, 1000);

            // ë‹¤ìŒ ë¬¸ì¥ íƒ€ì´ë¨¸ ì‹œì‘
            readTimer = setTimeout(() => {
                show_next_sentence(index + 1);
            }, countdown * 1000);
        }

        // --- ìœ í‹¸ë¦¬í‹° ---

        /**
         * (Pythonì˜ messagebox ëŒ€ì²´)
         */
        function showMessage(title, message) {
            messageTitle.textContent = title;
            messageText.textContent = message;
            messageModal.classList.remove('hidden');
        }

    </script>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">

        <!-- ìƒë‹¨: ì•± íƒ€ì´í‹€ -->
        <header class="bg-white shadow-md rounded-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-center text-blue-700">ì˜ì–´ ë¬¸ì¥ í•™ìŠµ ì›¹ ì•±</h1>
            <p class="text-center text-gray-600 mt-2">Firestore & Gemini API Ver. 2 (updated 2025/10/31)</p>
        </header>

        <!-- ëª¨ë“œ ì „í™˜ ë²„íŠ¼ -->
        <nav class="flex flex-wrap justify-center gap-4 mb-6">
            <button id="input-mode-btn" class="flex-1 min-w-[150px] bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed">
                ğŸ“ ë¬¸ì¥ ì…ë ¥ ë° ê´€ë¦¬
            </button>
            <button id="study-mode-btn" class="flex-1 min-w-[150px] bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed">
                ğŸ§  ë‹¤ì‹œ ê³µë¶€í•˜ê¸° (í•™ìŠµ)
            </button>
            <button id="reading-mode-btn" class="flex-1 min-w-[150px] bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed">
                ğŸ“– ê·¸ëƒ¥ ì½ê¸° (ë³µìŠµ)
            </button>
        </nav>

        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
        <main>
            <!-- 1. ë¬¸ì¥ ì…ë ¥ ëª¨ë“œ -->
            <div id="input-frame" class="bg-white p-6 rounded-lg shadow-lg hidden">
                <!-- ì…ë ¥ ì„¹ì…˜ -->
                <div class="bg-yellow-50 p-6 rounded-lg border-2 border-yellow-200">
                    <label for="input-english" class="block text-lg font-semibold mb-2 text-gray-700">ì˜ì–´ ë¬¸ì¥ ë˜ëŠ” ë‹¨ì–´:</label>
                    <input type="text" id="input-english" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500 text-lg" placeholder="ì—¬ê¸°ì— ì˜ì–´ ë¬¸ì¥ ì…ë ¥ í›„ Enter...">
                    
                    <div class="flex flex-wrap gap-4 mt-4 justify-center">
                        <button id="add-sentence-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out">
                            âœ“ ì…ë ¥ ë° ë²ˆì—­
                        </button>
                        
                        <!-- íŒŒì¼ ì…ë ¥ ë²„íŠ¼ (ë””ìì¸ ê°œì„ ) -->
                        <label for="file-input" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md cursor-pointer transition duration-300 ease-in-out">
                            ğŸ“ íŒŒì¼ë¡œ ì…ë ¥í•˜ê¸°
                        </label>
                        <input type="file" id="file-input" class="hidden" accept=".txt">
                        
                        <button id="delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out disabled:bg-gray-400" disabled>
                            ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ
                        </button>
                    </div>
                </div>

                <!-- ì €ì¥ëœ ë¬¸ì¥ ëª©ë¡ (Table) -->
                <div class="mt-8">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-800">ì €ì¥ëœ ë¬¸ì¥ ëª©ë¡</h3>
                    <!-- ëª¨ë°”ì¼ í™”ë©´ì—ì„œ ê°€ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • -->
                    <div class="overflow-x-auto shadow-md rounded-lg border border-gray-200">
                        <table class="w-full min-w-[800px] bg-white">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="p-3 text-left font-semibold text-gray-700">English Sentence</th>
                                    <th class="p-3 text-left font-semibold text-gray-700">Korean Meaning</th>
                                    <th class="p-3 text-center font-semibold text-gray-700">Date</th>
                                    <th class="p-3 text-center font-semibold text-gray-700">Study</th>
                                    <th class="p-3 text-center font-semibold text-gray-700">Correct</th>
                                    <th class="p-3 text-center font-semibold text-gray-700">Ratio</th>
                                    <th class="p-3 text-center font-semibold text-gray-700">Next Review</th>
                                </tr>
                            </thead>
                            <tbody id="sentence-list-body">
                                <!-- JSë¡œ ë Œë”ë§ -->
                                <tr>
                                    <td colspan="7" class="p-6 text-center text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 2. ë‹¤ì‹œ ê³µë¶€í•˜ê¸° ëª¨ë“œ -->
            <div id="study-frame" class="bg-green-50 p-6 md:p-10 rounded-lg shadow-lg text-center hidden">
                <p id="study-stats-overall" class="text-md font-semibold text-green-800 mb-4"></p>
                <h2 class="text-2xl font-bold text-green-900 mb-6">ë‹¤ìŒ ë¬¸ì¥ì„ ì˜ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”:</h2>

                <div class="bg-white p-6 md:p-10 rounded-lg shadow-inner min-h-[150px] flex items-center justify-center">
                    <p id="question-korean" class="text-3xl font-bold text-gray-800"></p>
                </div>

                <input type="text" id="user-answer-entry" class="w-full max-w-2xl mx-auto p-4 mt-8 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-green-500 text-lg" placeholder="ì—¬ê¸°ì— ì˜ì–´ ë‹µì•ˆ ì…ë ¥ í›„ Enter...">

                <!-- ê²°ê³¼ í”¼ë“œë°± -->
                <div id="result-frame" class="bg-orange-50 p-6 rounded-lg shadow-inner mt-6 max-w-2xl mx-auto hidden">
                    <h3 id="result-label" class="text-3xl font-bold mb-4"></h3>
                    <p id="correct-answer-label" class="text-lg text-gray-700 mb-2"></p>
                    <p id="user-input-label" class="text-lg text-red-600"></p>
                    
                    <div class="mt-6">
                        <button id="next-question-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out disabled:bg-gray-400">
                            â¡ï¸ ë‹¤ìŒ í•™ìŠµ
                        </button>
                    </div>
                </div>

                <p id="study-stats" class="text-md text-gray-600 mt-6 font-semibold"></p>
            </div>

            <!-- 3. ê·¸ëƒ¥ ì½ê¸° ëª¨ë“œ -->
            <div id="reading-frame" class="bg-blue-50 p-6 md:p-10 rounded-lg shadow-lg text-center hidden">
                <h2 class="text-2xl font-bold text-blue-900 mb-6">ğŸ“– ê·¸ëƒ¥ ì½ê¸° (ë³µìŠµ ëª¨ë“œ)</h2>
                
                <div class="mb-6">
                    <label for="speed-select" class="text-lg font-semibold text-gray-700 mr-3">ì½ê¸° ì†ë„ ì„ íƒ:</label>
                    <select id="speed-select" class="p-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500">
                        <option value="ë¹ ë¥´ê²Œ">ë¹ ë¥´ê²Œ</option>
                        <option value="ì¤‘ê°„" selected>ì¤‘ê°„</option>
                        <option value="ëŠë¦¬ê²Œ">ëŠë¦¬ê²Œ</option>
                    </select>
                </div>

                <!-- ë¬¸ì¥ í‘œì‹œ ì˜ì—­ -->
                <div class="bg-white p-10 rounded-lg shadow-inner min-h-[250px] flex items-center justify-center relative">
                    <p id="reading-display" class="text-4xl font-bold text-gray-800"></p>
                    <p id="countdown-display" class="absolute top-4 right-6 text-4xl font-bold text-orange-600"></p>
                </div>

                <p id="reading-progress" class="text-lg text-blue-800 mt-6 font-semibold"></p>
                
                <div class="flex justify-center gap-6 mt-6">
                    <button id="play-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out text-2xl">
                        â–¶ Play
                    </button>
                    <button id="stop-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out text-2xl disabled:bg-gray-400" disabled>
                        â¸ Stop
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- ë²”ìš© ë©”ì‹œì§€ ëª¨ë‹¬ (Pythonì˜ messagebox ëŒ€ì²´) -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full">
            <div class="p-6 border-b border-gray-200">
                <h3 id="message-title" class="text-xl font-semibold text-gray-800"></h3>
            </div>
            <div class="p-6">
                <p id="message-text" class="text-gray-600"></p>
            </div>
            <div class="p-4 bg-gray-50 text-right rounded-b-lg">
                <button id="message-close-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg transition duration-300 ease-in-out">
                    í™•ì¸
                </button>
            </div>
        </div>
    </div>
    
    <!-- íŒŒì¼ ì²˜ë¦¬ ì§„í–‰ ìƒí™© ëª¨ë‹¬ -->
    <div id="file-progress-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 text-center max-w-sm w-full">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">íŒŒì¼ ì²˜ë¦¬ ì¤‘</h3>
            <!-- ê°„ë‹¨í•œ ìŠ¤í”¼ë„ˆ -->
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
            <p id="file-progress-text" class="text-gray-700 text-lg"></p>
        </div>
    </div>

</body>
</html>


